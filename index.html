<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin System - การสอบการนวดไทย</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;500;700&family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --primary-gold: #D4AF37;
            --primary-dark: #1a2639;
            --accent-red: #8a1c1c;
            --text-light: #f4f4f4;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --modal-bg: #2c3e50;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--primary-dark);
            background-image: url("https://www.transparenttextures.com/patterns/black-scales.png");
            color: var(--text-light);
            margin: 0; padding: 20px;
        }

        /* --- Header & Layout --- */
        header { text-align: center; border-bottom: 2px solid var(--primary-gold); padding-bottom: 20px; margin-bottom: 20px; }
        h1 { font-family: 'Prompt', sans-serif; color: var(--primary-gold); margin: 0; }
        .container { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; max-width: 1200px; margin: 0 auto; }
        .column { background: var(--glass-bg); padding: 15px; border-radius: 10px; border: 1px solid #444; }
        .col-title { text-align: center; color: var(--primary-gold); font-family: 'Prompt'; font-size: 1.2rem; margin-bottom: 15px; border-bottom: 1px solid #555; padding-bottom: 5px; }

        /* --- Card Styles --- */
        .card {
            background: #fff; color: #333; padding: 12px; margin-bottom: 10px; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center; cursor: pointer;
            transition: transform 0.2s; border-left: 5px solid #ccc;
        }
        .card:hover { transform: scale(1.02); }
        .card-examining { border-left-color: var(--accent-red); background: #fff0f0; }
        .card-queue { border-left-color: #2ecc71; }
        .card-name { font-weight: bold; font-size: 1.1rem; }
        .card-info { font-size: 0.85rem; color: #666; }
        .badge-remain { background: var(--primary-dark); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; }
        
        /* --- Modal (Popup) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: var(--modal-bg); width: 90%; max-width: 500px; padding: 25px; border-radius: 15px;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.5); text-align: center; color: white; border: 2px solid var(--primary-gold);
        }
        .modal-header { font-size: 1.5rem; font-family: 'Prompt'; margin-bottom: 15px; color: var(--primary-gold); }
        
        /* --- Form Elements --- */
        select, button { width: 100%; padding: 10px; margin: 5px 0; border-radius: 5px; border: none; font-family: 'Sarabun'; }
        select { background: #eee; color: #333; font-size: 1rem; }
        .btn-start { background: #2ecc71; color: white; font-weight: bold; font-size: 1.1rem; cursor: pointer; }
        .btn-stop { background: #e74c3c; color: white; font-weight: bold; cursor: pointer; }
        .btn-finish { background: var(--primary-gold); color: #000; font-weight: bold; margin-top: 15px; cursor: pointer; }
        .btn-cancel { background: #95a5a6; color: white; cursor: pointer; }
        
        /* --- Timer --- */
        .timer-display { font-size: 3.5rem; font-family: 'Courier New', monospace; margin: 15px 0; color: #fff; font-weight: bold; }
        .control-group { display: flex; gap: 10px; }

        @media (max-width: 768px) { .container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<header>
    <h1><i class="fas fa-user-cog"></i> ผู้ดำเนินงานสอบ</h1>
    <div style="font-size: 0.9rem; color: #aaa;">คลิกที่ชื่อเพื่อจัดการสอบ / จับเวลา</div>
</header>

<div class="container">
    <div class="column">
        <div class="col-title">รอเรียก / คิวสอบ</div>
        <div id="list-waiting">Loading...</div>
    </div>
    <div class="column">
        <div class="col-title">กำลังสอบ (Examining)</div>
        <div id="list-examining">Loading...</div>
    </div>
</div>

<div id="examModal" class="modal-overlay">
    <div class="modal-content">
        <div id="modalName" class="modal-header">ชื่อผู้สอบ</div>
        
        <div id="selectionZone">
            <label style="text-align:left; display:block; color:#ccc;">เลือกหัวข้อสอบ:</label>
            <select id="topicSelect"></select>
            <button onclick="startExamProcess()" class="btn-start"><i class="fas fa-play"></i> เริ่มการสอบ</button>
        </div>

        <div id="timerZone" style="display:none;">
            <div style="color:var(--primary-gold); font-size:1.1rem;" id="currentTopicDisplay"></div>
            <div class="timer-display" id="timer">15:00</div>
            <div class="control-group">
                <button onclick="toggleTimer()" id="btnTimerToggle" class="btn-start">Start</button>
                <button onclick="resetTimer()" class="btn-stop">Reset</button>
            </div>
            <button onclick="finishExam()" class="btn-finish"><i class="fas fa-check-circle"></i> สอบเสร็จสิ้น / ผ่าน</button>
        </div>

        <button onclick="closeModal()" class="btn-cancel" style="margin-top:10px;">ปิดหน้าต่าง</button>
    </div>
</div>

<script>
    // ************************************************
    // ใส่ลิงก์ GAS Web App อันเดิมของคุณที่นี่
    const API_URL = "https://script.google.com/macros/s/AKfycby3XkXyTBYeA_jTeVb0KK6Ae3y2fqVxRkJEgRD_kkLG6T6xLKG6Dss5ZWbQGWbL5o7I/exec"; 
    // ************************************************

    const diseaseMap = {
        "1": "1. อัมพฤกษ์ อัมพาต",
        "2": "2. หมอนรองกระดูกทับเส้น",
        "3": "3. สลักเพชร",
        "4": "4. ไหล่ติด",
        "5": "5. ปวดกล้ามเนื้อ/พังผืด",
        "6": "6. นิ้วล็อก",
        "7": "7. ปวดเข่า"
    };

    let allStudents = [];
    let currentStudent = null;
    let timerInterval = null;
    let timeLeft = 900; // 15 minutes in seconds
    let isTimerRunning = false;

    // --- Main Logic ---
    async function fetchData() {
        try {
            const res = await fetch(API_URL);
            allStudents = await res.json();
            renderLists();
        } catch (e) { console.error(e); }
    }

    function renderLists() {
        const waitEl = document.getElementById('list-waiting');
        const examEl = document.getElementById('list-examining');
        waitEl.innerHTML = ''; examEl.innerHTML = '';

        allStudents.forEach(s => {
            const status = s.status.toLowerCase();
            const remainText = `<span class="badge-remain">เหลือ ${s.remaining}</span>`;
            
            const cardHtml = `
                <div class="card ${status === 'examining' ? 'card-examining' : 'card-queue'}" onclick="openModal('${s.id}')">
                    <div>
                        <div class="card-name">${s.name} ${remainText}</div>
                        <div class="card-info">
                            ${status === 'examining' ? `<i class="fas fa-heartbeat"></i> สอบ: ${diseaseMap[s.topic]}` : 'รอสอบ'}
                        </div>
                    </div>
                    <div><i class="fas fa-chevron-right" style="color:#ccc;"></i></div>
                </div>
            `;

            if (status === 'examining') examEl.innerHTML += cardHtml;
            else waitEl.innerHTML += cardHtml;
        });
    }

    // --- Modal Logic ---
    function openModal(id) {
        currentStudent = allStudents.find(s => s.id == id);
        if (!currentStudent) return;

        document.getElementById('modalName').innerText = currentStudent.name;
        document.getElementById('examModal').style.display = 'flex';
        
        // Reset View
        document.getElementById('selectionZone').style.display = 'block';
        document.getElementById('timerZone').style.display = 'none';
        resetTimer();

        // Populate Select Dropdown
        const select = document.getElementById('topicSelect');
        select.innerHTML = '';
        
        // ถ้ากำลังสอบอยู่ ให้โชว์หน้าจับเวลาเลย
        if (currentStudent.status.toLowerCase() === 'examining') {
            document.getElementById('selectionZone').style.display = 'none';
            document.getElementById('timerZone').style.display = 'block';
            document.getElementById('currentTopicDisplay').innerText = diseaseMap[currentStudent.topic];
        } else {
            // Filter topics
            for (let i = 1; i <= 7; i++) {
                // ถ้ายังไม่เคยสอบ (ไม่อยู่ใน history) ให้เพิ่มในตัวเลือก
                if (!currentStudent.history.includes(String(i))) {
                    let option = document.createElement("option");
                    option.value = i;
                    option.text = diseaseMap[i];
                    select.add(option);
                }
            }
            if(select.options.length === 0) {
                 let option = document.createElement("option");
                 option.text = "สอบครบทุกด้านแล้ว";
                 select.add(option);
                 document.querySelector('.btn-start').disabled = true;
            } else {
                document.querySelector('.btn-start').disabled = false;
            }
        }
    }

    function closeModal() {
        document.getElementById('examModal').style.display = 'none';
        clearInterval(timerInterval);
    }

    // --- Actions ---
    function startExamProcess() {
        const topic = document.getElementById('topicSelect').value;
        if(!topic) return;

        // Call API to update status
        sendUpdate('updateStatus', {
            id: currentStudent.id,
            status: 'Examining',
            topic: topic
        });

        // Switch UI locally immediately (UX)
        document.getElementById('selectionZone').style.display = 'none';
        document.getElementById('timerZone').style.display = 'block';
        document.getElementById('currentTopicDisplay').innerText = diseaseMap[topic];
    }

    function finishExam() {
        if(!confirm("ยืนยันว่าสอบเสร็จสิ้นและผ่าน?")) return;
        
        const topicKey = Object.keys(diseaseMap).find(key => diseaseMap[key] === document.getElementById('currentTopicDisplay').innerText);
        
        sendUpdate('finishExam', {
            id: currentStudent.id,
            topic: topicKey // ส่งหัวข้อปัจจุบันไปเพื่อบันทึกประวัติ
        });
        
        closeModal();
    }

    function sendUpdate(action, payload) {
        // ใช้ fetch POST ส่งข้อมูลกลับไป GAS
        // หมายเหตุ: GAS Web App อาจติด CORS แต่คำสั่งจะทำงานสำเร็จ ให้ใช้ no-cors หรือ handle error
        const formData = new FormData();
        formData.append('data', JSON.stringify({...payload, action: action}));
        
        fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({...payload, action: action})
        }).then(() => {
            setTimeout(fetchData, 1000); // Reload data
        }).catch(err => {
            console.log("Sent (Ignore CORS errors if changes appear)");
            setTimeout(fetchData, 2000);
        });
    }

    // --- Timer System ---
    function updateTimerDisplay() {
        const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
        const s = (timeLeft % 60).toString().padStart(2, '0');
        document.getElementById('timer').innerText = `${m}:${s}`;
    }

    function toggleTimer() {
        const btn = document.getElementById('btnTimerToggle');
        if (isTimerRunning) {
            clearInterval(timerInterval);
            isTimerRunning = false;
            btn.innerText = "Start";
            btn.style.background = "#2ecc71";
        } else {
            timerInterval = setInterval(() => {
                if (timeLeft > 0) {
                    timeLeft--;
                    updateTimerDisplay();
                } else {
                    clearInterval(timerInterval);
                    alert("หมดเวลาสอบ!");
                }
            }, 1000);
            isTimerRunning = true;
            btn.innerText = "Pause";
            btn.style.background = "#f39c12";
        }
    }

    function resetTimer() {
        clearInterval(timerInterval);
        isTimerRunning = false;
        timeLeft = 900; // 15 mins
        updateTimerDisplay();
        document.getElementById('btnTimerToggle').innerText = "Start";
    }

    // Auto Refresh List
    setInterval(fetchData, 5000);
    fetchData();

</script>
</body>
</html>
