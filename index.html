<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบคุมสอบนวดไทย - รพ.สะเดา</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;500;700&family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --primary-gold: #D4AF37;
            --primary-dark: #1a2639;
            --accent-red: #c0392b;
            --accent-green: #27ae60;
            --accent-orange: #f39c12;
            --bg-glass: rgba(255, 255, 255, 0.95);
        }
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--primary-dark);
            background-image: url("https://www.transparenttextures.com/patterns/black-scales.png");
            color: #333; margin: 0; padding: 20px;
        }
        
        /* Header & Nav */
        header { 
            display: flex; justify-content: space-between; align-items: center;
            color: var(--primary-gold); margin-bottom: 20px; border-bottom: 2px solid var(--primary-gold); padding-bottom: 10px;
        }
        .header-title h1 { margin: 0; font-family: 'Prompt'; font-size: 1.8rem; text-shadow: 2px 2px 4px black; }
        .btn-history { background: transparent; border: 1px solid var(--primary-gold); color: var(--primary-gold); padding: 8px 15px; border-radius: 5px; cursor: pointer; transition: 0.3s; }
        .btn-history:hover { background: var(--primary-gold); color: #000; }

        .container { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; max-width: 1400px; margin: 0 auto; }
        .col { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); padding: 15px; border-radius: 10px; border: 1px solid #555; color: white; min-height: 500px; }
        .col-head { text-align: center; font-family: 'Prompt'; font-size: 1.2rem; color: var(--primary-gold); border-bottom: 2px solid var(--primary-gold); padding-bottom: 10px; margin-bottom: 15px; }

        /* Card */
        .card { background: var(--bg-glass); color: #333; padding: 15px; margin-bottom: 10px; border-radius: 8px; cursor: pointer; position: relative; border-left: 5px solid #ccc; transition: transform 0.2s; }
        .card:hover { transform: translateY(-3px); }
        .card-wait { border-left-color: #7f8c8d; }
        .card-queue { border-left-color: #f1c40f; background: #fffbe6; }
        .card-exam { border-left-color: #e74c3c; background: #fff0f0; }
        .card-name { font-weight: bold; font-size: 1.1rem; }
        .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; margin-top: 5px; color: white;}
        .bg-topic { background: var(--primary-dark); }
        .elapsed-time { font-family: 'Courier New'; font-weight: bold; color: var(--accent-red); float: right; font-size: 1.2rem; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 999; }
        .modal-box { background: #2c3e50; width: 90%; max-width: 500px; padding: 30px; border-radius: 15px; text-align: center; color: white; border: 2px solid var(--primary-gold); max-height: 90vh; overflow-y: auto; }
        
        select, button { width: 100%; padding: 12px; margin: 6px 0; border-radius: 8px; font-size: 1rem; border: none; cursor: pointer; }
        .btn-blue { background: #3498db; color: white; font-weight: bold; }
        .btn-green { background: var(--accent-green); color: white; font-weight: bold; }
        .btn-red { background: var(--accent-red); color: white; font-weight: bold; }
        .btn-yellow { background: var(--accent-orange); color: white; font-weight: bold; }
        .btn-grey { background: #95a5a6; color: white; }
        .btn-close { background: #34495e; color: #ccc; margin-top: 15px; border: 1px solid #555; }
        
        /* Grid Buttons for Pass/Fail */
        .btn-group-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }

        /* Timer */
        .timer-big { font-size: 4rem; font-family: 'Courier New', monospace; font-weight: bold; margin: 10px 0; }
        .timer-normal { color: white; }
        .timer-orange { color: var(--accent-orange); animation: blink 1s infinite; }
        .timer-red { color: var(--accent-red); animation: shake 0.5s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-1px, -1px); } 100% { transform: translate(1px, 1px); } }

        /* History Table */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; color: #ccc; font-size: 0.9rem; }
        th, td { border-bottom: 1px solid #444; padding: 8px; text-align: left; }
        th { color: var(--primary-gold); }
        .res-pass { color: var(--accent-green); }
        .res-fail { color: var(--accent-red); }

        @media (max-width: 768px) { .container { grid-template-columns: 1fr; } header { flex-direction: column; gap: 10px;} }
    </style>
</head>
<body>

<header>
    <div class="header-title">
        <h1><i class="fas fa-stopwatch"></i> ระบบคุมสอบนวดไทย</h1>
        <div style="font-size:0.9rem;">โรงพยาบาลสะเดา</div>
    </div>
    <button onclick="openHistory()" class="btn-history"><i class="fas fa-history"></i> ดูบันทึกย้อนหลัง</button>
</header>

<div class="container">
    <div class="col">
        <div class="col-head"><i class="fas fa-chair"></i> พักรอสอบ (Waiting)</div>
        <div id="list-waiting"></div>
    </div>
    <div class="col">
        <div class="col-head"><i class="fas fa-user-clock"></i> รอหน้าห้อง (Queue)</div>
        <div id="list-queue"></div>
    </div>
    <div class="col">
        <div class="col-head"><i class="fas fa-procedures"></i> กำลังสอบ (Examining)</div>
        <div id="list-exam"></div>
    </div>
</div>

<div id="modal" class="modal-overlay">
    <div class="modal-box">
        <h2 id="mName" style="color:var(--primary-gold); margin-top:0;">ชื่อผู้สอบ</h2>
        <div id="mTopic" style="color:#aaa; margin-bottom:15px;"></div>

        <div id="stage-select" style="display:none;">
            <select id="selTopic"></select>
            <button onclick="actionToQueue()" class="btn-blue"><i class="fas fa-bullhorn"></i> เรียกตัวมารอหน้าห้อง</button>
        </div>

        <div id="stage-start" style="display:none;">
            <div style="font-size:1.2rem; margin-bottom:10px;">พร้อมเข้าห้องสอบไหม?</div>
            <button onclick="actionStartExam()" class="btn-green"><i class="fas fa-play"></i> เริ่มจับเวลา (เข้าห้อง)</button>
        </div>

        <div id="stage-timer" style="display:none;">
            <div id="timerDisplay" class="timer-big timer-normal">15:00</div>
            
            <div class="btn-group-row">
                <button id="btnToggle" onclick="toggleTimer()" class="btn-grey" style="width:100%">Start</button>
                <button onclick="resetTimer()" class="btn-grey" style="width:100%">Reset</button>
            </div>

            <hr style="border-color:#444; margin: 15px 0;">
            
            <div style="text-align:left; font-size:0.9rem; color:#aaa;">บันทึกผลการสอบ:</div>
            <div class="btn-group-row">
                <button onclick="actionFinishExam('Pass')" class="btn-green"><i class="fas fa-check-circle"></i> สอบผ่าน</button>
                <button onclick="actionFinishExam('Fail')" class="btn-red"><i class="fas fa-times-circle"></i> ไม่ผ่าน</button>
            </div>

            <button onclick="actionBackToQueue()" class="btn-yellow" style="margin-top:10px;">
                <i class="fas fa-undo"></i> ยกเลิก/กลับไปรอหน้าห้อง
            </button>
        </div>

        <button onclick="closeModal()" class="btn-close">ปิดหน้าต่าง</button>
    </div>
</div>

<div id="historyModal" class="modal-overlay">
    <div class="modal-box" style="max-width:600px;">
        <h2 style="color:var(--primary-gold); margin-top:0;"><i class="fas fa-list-alt"></i> บันทึกการสอบล่าสุด</h2>
        <div id="historyList" style="text-align:left;">Loading...</div>
        <button onclick="document.getElementById('historyModal').style.display='none'" class="btn-close">ปิด</button>
    </div>
</div>

<script>
    // **********************************
    const API_URL = "https://script.google.com/macros/s/AKfycby3XkXyTBYeA_jTeVb0KK6Ae3y2fqVxRkJEgRD_kkLG6T6xLKG6Dss5ZWbQGWbL5o7I/exec"; // <--- ใส่ลิงก์ตรงนี้
    // **********************************

    const diseaseMap = { "1":"อัมพฤกษ์", "2":"หมอนรองกระดูก", "3":"สลักเพชร", "4":"ไหล่ติด", "5":"กล้ามเนื้อ/พังผืด", "6":"นิ้วล็อก", "7":"ปวดเข่า" };
    
    let allData = [];
    let currentStudent = null;
    let modalTimerInterval = null;
    let timeLeft = 900; 
    let isTimerRunning = false;

    setInterval(fetchData, 2000); 
    setInterval(updateCardTimers, 1000); 
    fetchData();

    async function fetchData() {
        try {
            const res = await fetch(API_URL);
            allData = await res.json();
            renderUI();
        } catch(e) { console.log(e); }
    }

    function renderUI() {
        const waiting = document.getElementById('list-waiting');
        const queue = document.getElementById('list-queue');
        const exam = document.getElementById('list-exam');
        
        waiting.innerHTML = ''; queue.innerHTML = ''; exam.innerHTML = '';

        allData.forEach(s => {
            const status = s.status ? s.status.toLowerCase() : 'waiting';
            const topicName = diseaseMap[s.topic] || "";
            
            let html = `
                <div class="card ${getStatusClass(status)}" onclick="openModal('${s.id}')">
                    <div class="card-name">${s.name} <span style="font-size:0.8rem; color:#666;">(เหลือ ${s.remaining})</span></div>
            `;
            
            if(status === 'examining') {
                html += `
                    <div style="margin-top:5px;">
                        <span class="badge bg-topic">${topicName}</span>
                        <span id="timer-${s.id}" class="elapsed-time">00:00</span>
                    </div></div>`;
                exam.innerHTML += html;
            } else if (status === 'queue') {
                html += `
                    <div style="margin-top:5px; color:#e67e22;">
                        <i class="fas fa-hourglass-half"></i> รอสอบ: <b>${topicName}</b>
                    </div></div>`;
                queue.innerHTML += html;
            } else {
                html += `</div>`;
                waiting.innerHTML += html;
            }
        });
    }

    function getStatusClass(s) {
        if(s === 'examining') return 'card-exam';
        if(s === 'queue') return 'card-queue';
        return 'card-wait';
    }

    function updateCardTimers() {
        allData.forEach(s => {
            if(s.status && s.status.toLowerCase() === 'examining' && s.startTime) {
                const el = document.getElementById(`timer-${s.id}`);
                if(el) {
                    const diff = Math.floor((Date.now() - s.startTime) / 1000);
                    if(diff >= 0) {
                        const m = Math.floor(diff / 60).toString().padStart(2,'0');
                        const s_sec = (diff % 60).toString().padStart(2,'0');
                        el.innerText = `⏱ ${m}:${s_sec}`;
                    }
                }
            }
        });
    }

    // --- Modal Logic ---
    function openModal(id) {
        currentStudent = allData.find(x => x.id == id);
        if(!currentStudent) return;

        document.getElementById('modal').style.display = 'flex';
        document.getElementById('mName').innerText = currentStudent.name;
        document.getElementById('mTopic').innerText = diseaseMap[currentStudent.topic] || "";

        document.getElementById('stage-select').style.display = 'none';
        document.getElementById('stage-start').style.display = 'none';
        document.getElementById('stage-timer').style.display = 'none';

        resetTimer(); 

        let status = currentStudent.status ? currentStudent.status.toLowerCase() : 'waiting';
        if (status === '') status = 'waiting';

        if(status === 'waiting') {
            document.getElementById('stage-select').style.display = 'block';
            const sel = document.getElementById('selTopic');
            sel.innerHTML = '';
            let history = currentStudent.history || [];
            
            for(let k in diseaseMap) {
                if(!history.includes(k)) {
                    let opt = document.createElement('option');
                    opt.value = k; opt.innerText = diseaseMap[k];
                    sel.appendChild(opt);
                }
            }
            if(sel.options.length === 0) {
                 let opt = document.createElement('option'); opt.innerText = "สอบครบแล้ว"; sel.appendChild(opt);
                 document.querySelector('#stage-select button').disabled = true;
            } else {
                 document.querySelector('#stage-select button').disabled = false;
            }

        } else if (status === 'queue') {
            document.getElementById('stage-start').style.display = 'block';

        } else if (status === 'examining') {
            document.getElementById('stage-timer').style.display = 'block';
            
            if(currentStudent.startTime) {
                const EXAM_DURATION = 15 * 60; 
                const elapsed = Math.floor((Date.now() - currentStudent.startTime) / 1000);
                const remaining = EXAM_DURATION - elapsed;
                timeLeft = (remaining > 0) ? remaining : 0;
            }
            updateTimerDisplay();
            startTimer(); 
        }
    }

    // --- History Logic ---
    function openHistory() {
        document.getElementById('historyModal').style.display = 'flex';
        document.getElementById('historyList').innerHTML = '<div style="text-align:center;">กำลังโหลด...</div>';
        
        fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'getLogs' })
        })
        .then(res => res.json())
        .then(data => {
            if(data.length === 0) {
                document.getElementById('historyList').innerHTML = '<div style="text-align:center;">ยังไม่มีประวัติการสอบ</div>';
                return;
            }
            let html = '<table><thead><tr><th>เวลา</th><th>ชื่อ</th><th>โรค</th><th>ผล</th></tr></thead><tbody>';
            data.forEach(row => {
                const date = new Date(row[0]);
                const timeStr = date.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'});
                const topic = diseaseMap[row[2]] || row[2];
                const resClass = row[3] === 'Pass' ? 'res-pass' : 'res-fail';
                const resText = row[3] === 'Pass' ? 'ผ่าน' : 'ไม่ผ่าน';
                
                html += `<tr>
                    <td>${timeStr}</td>
                    <td>${row[1]}</td>
                    <td>${topic}</td>
                    <td class="${resClass}">${resText}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('historyList').innerHTML = html;
        });
    }

    // --- Timer Functions ---
    function updateTimerDisplay() {
        const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
        const s = (timeLeft % 60).toString().padStart(2, '0');
        const display = document.getElementById('timerDisplay');
        display.innerText = `${m}:${s}`;
        
        display.className = "timer-big timer-normal";
        if(timeLeft <= 300) display.className = "timer-big timer-orange";
        if(timeLeft <= 60) display.className = "timer-big timer-red";
    }

    function toggleTimer() { isTimerRunning ? pauseTimer() : startTimer(); }

    function startTimer() {
        if(isTimerRunning) return;
        isTimerRunning = true;
        document.getElementById('btnToggle').innerText = "Pause";
        document.getElementById('btnToggle').className = "btn-yellow"; 

        modalTimerInterval = setInterval(() => {
            if(timeLeft > 0) {
                timeLeft--;
                updateTimerDisplay();
            } else {
                pauseTimer();
                alert("หมดเวลาสอบ!");
            }
        }, 1000);
    }

    function pauseTimer() {
        isTimerRunning = false;
        clearInterval(modalTimerInterval);
        document.getElementById('btnToggle').innerText = "Start";
        document.getElementById('btnToggle').className = "btn-green";
    }

    function resetTimer() {
        pauseTimer();
        timeLeft = 900; 
        updateTimerDisplay();
    }

    function closeModal() {
        document.getElementById('modal').style.display = 'none';
        pauseTimer(); 
    }

    // --- API Calls ---
    function actionToQueue() {
        const topic = document.getElementById('selTopic').value;
        sendAPI('toQueue', { id: currentStudent.id, topic: topic });
        closeModal();
    }
    function actionStartExam() {
        sendAPI('startExam', { id: currentStudent.id });
        closeModal(); 
    }
    
    // ฟังก์ชันใหม่: รองรับ Pass/Fail
    function actionFinishExam(result) {
        let msg = result === 'Pass' ? "ยืนยันให้ 'สอบผ่าน' ใช่ไหม?" : "ยืนยันให้ 'สอบไม่ผ่าน' ใช่ไหม?";
        if(!confirm(msg)) return;
        sendAPI('finishExam', { id: currentStudent.id, topic: currentStudent.topic, result: result });
        closeModal();
    }
    
    // ฟังก์ชันใหม่: กลับไปรอหน้าห้อง
    function actionBackToQueue() {
        if(!confirm("ต้องการยกเลิกการสอบ และให้กลับไปรอหน้าห้องสอบ (คิว) ใช่ไหม?")) return;
        sendAPI('backToQueue', { id: currentStudent.id });
        closeModal();
    }

    function sendAPI(action, payload) {
        fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({ action: action, ...payload })
        }).then(r => fetchData());
    }
</script>
</body>
</html>
